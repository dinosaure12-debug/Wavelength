<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Wavelength – Mobile</title>

<style>
:root{
  --bg:#0b1220;
  --panel:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.14);
  --text:#f9fafb;
  --muted:rgba(255,255,255,.70);
  --accent:#f97316;
  --green:#22c55e;
  --orange:#f59e0b;
  --red:#ef4444;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Arial, sans-serif;
  background:
    radial-gradient(900px 500px at 20% 0%, rgba(249,115,22,.12), transparent 60%),
    radial-gradient(900px 500px at 80% 10%, rgba(59,130,246,.10), transparent 60%),
    var(--bg);
  color:var(--text);
  padding:12px;
  display:flex;
  justify-content:center;
}

.app{
  width:min(760px,100%);
  display:flex;
  flex-direction:column;
  gap:12px;
}

.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:14px;
}

.turn{
  text-align:center;
  font-size:26px;
  font-weight:900;
}

.subturn{
  text-align:center;
  font-size:14px;
  color:var(--muted);
}

.pair{
  display:flex;
  justify-content:center;
  gap:12px;
  font-weight:900;
  font-size:18px;
  flex-wrap:wrap;
  align-items:center;
}

.pill{
  padding:8px 14px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid var(--border);
  min-width: 160px;
  text-align:center;
}

.vs{ color: rgba(255,255,255,.65); font-weight:900; }

canvas{
  width:100%;
  max-width:560px;
  margin:auto;
  display:block;
  border-radius:18px;
  background:rgba(0,0,0,.2);
  border:1px solid var(--border);
  touch-action:none;
}

button{
  padding:12px 18px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.2);
  color:var(--text);
  font-weight:900;
  cursor:pointer;
}

button.primary{
  background:linear-gradient(180deg, #f97316, #fb923c);
  color:#111;
}

.hidden{display:none}

.scoreline{
  display:flex;
  justify-content:space-between;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.2);
}

/* Slider zone */
.sliderWrap{
  max-width:560px;
  margin: 12px auto 0 auto;
  padding: 10px 12px;
  border-radius: 14px;
  border:1px solid var(--border);
  background: rgba(0,0,0,.16);
}
.sliderTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:8px;
}
.badge{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  font-size:12px;
  color: rgba(255,255,255,.85);
  font-weight:900;
  white-space:nowrap;
}
input[type="range"]{
  width:100%;
  accent-color: var(--accent);
}
.legend{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
  font-size:12px;
  color: rgba(255,255,255,.78);
}
.dot{
  display:inline-block;
  width:10px;
  height:10px;
  border-radius:999px;
  margin-right:6px;
  vertical-align:middle;
}
</style>
</head>

<body>
<div class="app">

  <div class="panel">
    <div class="turn" id="turnTitle">Configuration</div>
    <div class="subturn" id="turnSub"></div>
  </div>

  <div class="panel">
    <div class="pair" id="pair"></div>
  </div>

  <div class="panel">
    <canvas id="canvas" width="800" height="500"></canvas>

    <!-- Slider (visible uniquement en phase équipe) -->
    <div id="sliderWrap" class="sliderWrap hidden">
      <div class="sliderTop">
        <div class="badge">Réglage précis</div>
        <div class="badge">Valeur : <span id="sliderVal">50</span></div>
      </div>
      <input id="needleSlider" type="range" min="0" max="100" step="1" value="50" />
      <div class="legend">
        <span><span class="dot" style="background:var(--green)"></span>Vert ±3% = 4 pts</span>
        <span><span class="dot" style="background:var(--orange)"></span>Orange ±5% = 2 pts</span>
        <span><span class="dot" style="background:var(--red)"></span>Rouge ±8% = 1 pt</span>
      </div>
    </div>
  </div>

  <div class="panel" style="text-align:center;">
    <button id="actionBtn" class="primary">Commencer</button>
  </div>

  <div class="panel hidden" id="scoresPanel">
    <h3 style="margin:0 0 10px 0;">Scores</h3>
    <div id="scores"></div>
  </div>

</div>

<script>
/* ===================== THEMES ===================== */
const PAIRS = [
  ["Rappeur inconnu","Rappeur légendaire"],
  ["Acteur éclaté","Acteur immense"],
  ["Jeu vidéo niche","Jeu vidéo mythique"],
  ["Punchline faible","Punchline assassine"],
  ["Ville éclatée","Ville incroyable"],
  ["Film chiant","Film addictif"],
  ["Humour gênant","Humour masterclass"],
];

/* ===================== STATE ===================== */
let players = [];
let psychicIndex = 0;

let phase = "setup"; // setup | psychic | team | reveal
let secret = 0;

// thème figé pour toute la manche
let roundPair = null;

// guesses par index joueur
let guesses = {};      // { "1": 63, "2": 41, ... }

// pour l’équipe : placement courant (modifiable au drag et au slider)
let currentNeedle = 50;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const turnTitle = document.getElementById("turnTitle");
const turnSub   = document.getElementById("turnSub");
const pairDiv   = document.getElementById("pair");
const btn       = document.getElementById("actionBtn");
const scoresDiv = document.getElementById("scores");
const scoresPanel = document.getElementById("scoresPanel");

const sliderWrap = document.getElementById("sliderWrap");
const needleSlider = document.getElementById("needleSlider");
const sliderVal = document.getElementById("sliderVal");

/* ===================== SCORING ZONES (TES REGLES) ===================== */
/*
  Vert   : ±3   -> 4 pts
  Orange : ±5   -> 2 pts
  Rouge  : ±8   -> 1 pt
  Sinon  : 0 pt
*/
const Z_GREEN = 3;
const Z_ORANGE = 5;
const Z_RED = 8;

function pointsForGuess(guess){
  const d = Math.abs(guess - secret);
  if(d <= Z_GREEN) return 4;
  if(d <= Z_ORANGE) return 2;
  if(d <= Z_RED) return 1;
  return 0;
}

/* ===================== UTILS ===================== */
const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

function renderPair(){
  if(!roundPair) return;
  const [L,R] = roundPair;
  pairDiv.innerHTML = `
    <span class="pill">${L}</span>
    <span class="vs">↔</span>
    <span class="pill">${R}</span>
  `;
}

/* ===================== DRAW (avec zones colorées) ===================== */
function pctToAngle(pct){ return Math.PI*(1 - pct/100); }

function draw(needle, opts){
  // opts: { showSecret, showNeedleValue, showZones, showSecretMarker }
  const showZones = !!opts?.showZones;
  const showSecretMarker = !!opts?.showSecretMarker;
  const showNeedleValue = !!opts?.showNeedleValue;

  ctx.clearRect(0,0,800,500);
  const cx=400, cy=430, r=300;

  // base arc
  ctx.strokeStyle="rgba(255,255,255,.20)";
  ctx.lineWidth=60;
  ctx.lineCap="round";
  ctx.beginPath();
  ctx.arc(cx,cy,r,Math.PI,0);
  ctx.stroke();

  // zones (rouge puis orange puis vert par-dessus)
  if(showZones){
    drawZoneArc(cx,cy,r, Z_RED,   "rgba(239,68,68,.35)");   // rouge
    drawZoneArc(cx,cy,r, Z_ORANGE,"rgba(245,158,11,.35)");  // orange
    drawZoneArc(cx,cy,r, Z_GREEN, "rgba(34,197,94,.40)");   // vert
  }

  // needle
  const a = pctToAngle(needle);
  const nx = cx + Math.cos(a)*r;
  const ny = cy - Math.sin(a)*r;

  ctx.strokeStyle="rgba(255,255,255,.92)";
  ctx.lineWidth=6;
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(nx,ny);
  ctx.stroke();

  ctx.fillStyle="rgba(255,255,255,.92)";
  ctx.beginPath();
  ctx.arc(cx,cy,12,0,Math.PI*2);
  ctx.fill();

  // secret marker
  if(showSecretMarker){
    const as = pctToAngle(secret);
    ctx.fillStyle="#f97316";
    ctx.beginPath();
    ctx.arc(cx+Math.cos(as)*r, cy-Math.sin(as)*r, 8,0,Math.PI*2);
    ctx.fill();
  }

  // numeric feedback (team)
  if(showNeedleValue){
    ctx.fillStyle="rgba(255,255,255,.88)";
    ctx.font="900 30px Arial";
    ctx.textAlign="center";
    ctx.fillText(String(needle), cx, 70);
    ctx.font="700 14px Arial";
    ctx.fillStyle="rgba(255,255,255,.60)";
    ctx.fillText("Ton placement", cx, 95);
  }
}

function drawZoneArc(cx,cy,r, radiusPct, color){
  const left = clamp(secret - radiusPct, 0, 100);
  const right = clamp(secret + radiusPct, 0, 100);

  const aLeft = pctToAngle(left);
  const aRight = pctToAngle(right);

  ctx.strokeStyle = color;
  ctx.lineWidth = 60;
  ctx.lineCap = "round";
  ctx.beginPath();
  ctx.arc(cx,cy,r,aRight,aLeft);
  ctx.stroke();
}

/* ===================== GAME FLOW ===================== */
function startGame(){
  const raw = prompt("Pseudos séparés par des virgules (ex: Sam, Lina, Mehdi)") || "";
  const names = raw.split(",").map(s=>s.trim()).filter(Boolean);
  if(names.length < 2){
    alert("Il faut au moins 2 participants.");
    return;
  }
  players = names.map(n=>({name:n, score:0}));
  psychicIndex = rand(0, players.length-1);
  nextRound();
}

function nextRound(){
  guesses = {};
  secret = rand(0,100);
  roundPair = PAIRS[rand(0, PAIRS.length-1)];   // figé
  currentNeedle = 50;
  phase = "psychic";
  updateUI();
}

function getNextTeamPlayerIndex(){
  for(let i=0;i<players.length;i++){
    if(i === psychicIndex) continue;
    if(guesses[i] == null) return i;
  }
  return null;
}

/* ===================== UI ===================== */
function updateScores(){
  scoresDiv.innerHTML = "";
  players.forEach((p, idx)=>{
    scoresDiv.innerHTML += `
      <div class="scoreline">
        <b>${p.name}${idx===psychicIndex ? " (Psychic)" : ""}</b>
        <span>${p.score} pts</span>
      </div>
    `;
  });
}

function syncSlider(){
  needleSlider.value = String(currentNeedle);
  sliderVal.textContent = String(currentNeedle);
}

function updateUI(){
  renderPair();

  // slider uniquement en phase team
  sliderWrap.classList.toggle("hidden", phase !== "team");

  if(phase === "setup"){
    turnTitle.textContent = "Configuration";
    turnSub.textContent = "Clique sur Commencer";
    draw(50,{showZones:false, showSecretMarker:false, showNeedleValue:false});
    btn.textContent = "Commencer";
    btn.onclick = startGame;
    return;
  }

  if(phase === "psychic"){
    const psychicName = players[psychicIndex].name;
    turnTitle.textContent = "TOUR DU PSYCHIC";
    turnSub.textContent = `${psychicName} — Secret: ${secret} (à ne pas dire)`;
    // on affiche clairement les zones de points autour du secret
    draw(secret,{showZones:true, showSecretMarker:true, showNeedleValue:false});
    btn.textContent = "Passer à l'équipe";
    btn.onclick = ()=>{
      phase = "team";
      currentNeedle = 50;
      syncSlider();
      updateUI();
    };
    return;
  }

  if(phase === "team"){
    const idx = getNextTeamPlayerIndex();
    if(idx == null){
      phase = "reveal";
      updateUI();
      return;
    }
    const name = players[idx].name;
    turnTitle.textContent = "TOUR DE L'ÉQUIPE";
    turnSub.textContent = `${name} — règle l’aiguille puis valide`;
    syncSlider();
    draw(currentNeedle,{showZones:false, showSecretMarker:false, showNeedleValue:true});

    btn.textContent = "Valider mon placement";
    btn.onclick = ()=>{
      guesses[idx] = currentNeedle;
      currentNeedle = 50;
      syncSlider();
      updateUI();
    };
    return;
  }

  if(phase === "reveal"){
    turnTitle.textContent = "RÉVÉLATION";
    turnSub.textContent = `Secret: ${secret} — (zones: vert ±3, orange ±5, rouge ±8)`;
    // on montre zones + secret
    draw(secret,{showZones:true, showSecretMarker:true, showNeedleValue:false});

    // calcule points (selon TES zones) pour tous hors psychic
    for(const [k,v] of Object.entries(guesses)){
      const i = Number(k);
      const pts = pointsForGuess(v);
      players[i].score += pts;
    }

    scoresPanel.classList.remove("hidden");
    updateScores();

    btn.textContent = "Manche suivante (Psychic suivant)";
    btn.onclick = ()=>{
      psychicIndex = (psychicIndex + 1) % players.length;
      nextRound();
    };
    return;
  }
}

/* ===================== TEAM CONTROL: Canvas drag + Slider ===================== */
function pointerToPct(ev){
  const rect = canvas.getBoundingClientRect();
  const x = clamp((ev.clientX - rect.left) / rect.width, 0, 1);
  return Math.round(x * 100);
}

let dragging = false;

// drag on canvas (team only)
canvas.addEventListener("pointerdown", (e)=>{
  if(phase !== "team") return;
  dragging = true;
  canvas.setPointerCapture(e.pointerId);
  currentNeedle = pointerToPct(e);
  syncSlider();
  draw(currentNeedle,{showZones:false, showSecretMarker:false, showNeedleValue:true});
});
canvas.addEventListener("pointermove", (e)=>{
  if(!dragging) return;
  if(phase !== "team") return;
  currentNeedle = pointerToPct(e);
  syncSlider();
  draw(currentNeedle,{showZones:false, showSecretMarker:false, showNeedleValue:true});
});
canvas.addEventListener("pointerup", ()=> dragging=false);
canvas.addEventListener("pointercancel", ()=> dragging=false);

// slider (team only)
needleSlider.addEventListener("input", ()=>{
  if(phase !== "team") return;
  currentNeedle = Number(needleSlider.value);
  sliderVal.textContent = String(currentNeedle);
  draw(currentNeedle,{showZones:false, showSecretMarker:false, showNeedleValue:true});
});

/* init */
phase = "setup";
updateUI();
</script>

</body>
</html>